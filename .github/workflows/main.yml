name: KITT CI/CD Installer Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Permet de lancer le test manuellement depuis l'onglet Actions

jobs:
  test-macos:
    name: Run Installer on macOS
    runs-on: macos-latest

    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üêç Configuration Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üõ† Diagnostic Pr√©-installation
        run: |
          echo "--- INFOS SYST√àME ---"
          sw_vers
          which curl
          curl --version
          python3 --version

      - name: üöÄ Lancement de l'installateur KITT
        run: |
          # On lance le script en mode terminal
          # On s'assure que le script est ex√©cutable
          chmod +x kitt_installer.py
          python3 kitt_installer.py
        env:
          # On simule un environnement sans GUI pour √©viter les erreurs Tkinter si elles existent
          PYTHONUNBUFFERED: 1

      - name: üß™ V√©rification des fichiers g√©n√©r√©s
        run: |
          echo "--- V√âRIFICATION DU DOSSIER .KITT ---"
          ls -la ~/.kitt
          
          echo "--- V√âRIFICATION DE L'APPLICATION ---"
          if [ -d "$HOME/Applications/KITT.app" ]; then
            echo "‚úÖ KITT.app a √©t√© cr√©√©e avec succ√®s dans ~/Applications"
          else
            echo "‚ùå KITT.app est introuvable"
            exit 1
          fi

      - name: ü§ñ V√©rification Ollama (Optionnel)
        run: |
          # V√©rifie si le mod√®le a bien √©t√© enregistr√© dans Ollama
          # Note : Cela peut √©chouer si le d√©mon Ollama n'a pas fini de d√©marrer
          ollama list | grep "kitt-ai" || echo "Note: Mod√®le kitt-ai non list√© (Ollama service peut √™tre offline)"
